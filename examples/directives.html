<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="user-scalable=no">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Superviews</title>

  <style>
    .active {
      color: red;
    }
  </style>
  <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script src="../node_modules/micro-template/lib/micro-template.js"></script>
  <script src="../dist/supermodels.js"></script>
</head>

<body>

  <h1>A look at loops</h1>
  
  <div ui-with="app" ui-title="name">

    <p ui-text="name"></p>

    <ul ui-for="items">
      <li>
        <span ui-text="name"></span>&nbsp;|&nbsp;<span ui-text="text"></span>
      </li>
    </ul>

    <pre id="json">
      
    </pre>
  </div>

  <script>
  var prefix = 'ui';
  
    function genAttrName(name) {
      return prefix + '-' + name;
    }
    
    var ui = {
      for: function(value) {
        var $this = $(this);
        var dataKey = prefix + '-for-data';
        var templateKey = prefix + '-for-template';
        
        // If the array hasn't changed 'shape', do no work
        var data = $this.data(dataKey);
        if (data) {
          if (data.length === value.length) {
            // todo: and they contain the same items etc...
            return;
          }
        }
        
        var template = $this.data(templateKey);
        if (!template) {
          template = $this.html();
          $this.data(templateKey, template);
        }
        
        var $item;
        var withAttr = genAttrName('with');
        
        $this.html('');
        for (var i = 0; i < value.length; i++) {
          $this.append($(template).attr(withAttr, '[' + i + ']'));
        }
        
        // make a copy of the current items
        $this.data(dataKey, value.slice());
      },
      value: function(value) {
        this.value = value;
      },
      text: function(value) {
        this.innerText = value;
      },
      hide: function(value) {
        this.style.display = value ? 'none' : '';
      },
      title: function(value) {
        this.title = value;
      },
      max: function(value) {
        this.max = value;
      },
      'class': function(value) {
        $(this).addClass(value);
      }
    };

    var app = supermodels({
      name: String,
      items: [{
        name: '',
        text: '',
        quantity: Number
      }]
    });

    var newItem1 = app.items.create();
    newItem1.name = 'item1';
    newItem1.text = 'item1 text';
    newItem1.quantity = 4;
    app.items.push(newItem1);
    
    var newItem2 = app.items.create();
    newItem2.name = 'item2';
    newItem2.text = 'item2 text';
    newItem2.quantity = 4;
    app.items.push(newItem2);
    
    // add a few blank items
    app.items.push(app.items.create());
    app.items.push(app.items.create());
    app.items.push(app.items.create());
    app.items.push(app.items.create());
    
    function renderJson() {
      $('#json').html(JSON.stringify(app, null, 2));
    }
    renderJson()
    
    app.on('change', function() {
      renderJson();
      scan();
    });



  var directives = {
    text: function(value) {
      this.innerText = value;
    },
    'for': function(exprStr) {
      
      // here 'this' is the element
      
      return function(value) {
        this.innerText = value;
      }
      
    }
  };



    var keys = Object.keys(ui);

    function scan(el) {
      var $el = $(el || document.body);

      keys.forEach(function(key) {
        var attrName = genAttrName(key);
        var $found = $('[' + attrName + ']', $el);

        $found.each(function(index, item) {
          var $this = $(this);
          var value = $this.evaluate(attrName);
          ui[key].call(item, value);
        });
      });

    }

    (function($) {

      $.fn.ctx = function() {
        var $this = $(this);
        var withs = [];
        var contextAttrs = [genAttrName('with'), genAttrName('for')];
        var contextAttrsSelectors = contextAttrs.map(function(item) {
          return '[' + item + ']';
        });
        
        function push(name, dot) {
          if (dot !== false) {
            withs.push('.');
          }
          withs.push(name);
        }
        
        if ($this.is(contextAttrsSelectors[0])) {
          push($this.attr(contextAttrs[0]));
        }
        
        $this.parents(contextAttrsSelectors.join(',')).each(function() {
          var $parent = $(this);
          
          if ($parent.is(contextAttrsSelectors[0])) {
            push($parent.attr(contextAttrs[0]));
            
          } else if ($parent.is(contextAttrsSelectors[1])) {
            push($parent.attr(contextAttrs[1]), false);
            
          }
        });
        
        withs.shift();
        return withs.reverse().join('');

      };

    }(jQuery));
    
    (function($) {

      $.fn.evaluate = function(attrName) {
        var $this = $(this);
        return eval('with (' + $this.ctx() + ') {\n' + $this.attr(attrName) + '\n}')
      };

    }(jQuery));
    $(function() {

      // Contextify dom 'on' events
    
      $('[onclick]').each(function(index, item) {
        var ctx = $(this).ctx();
        var fn = new Function('e', 'with (' + ctx + ') {\n' + $(this).attr('onclick') + '\nconsole.log("onclick");\n}');
        this.onclick = fn;
      });
      $('[onkeypress]').each(function(index, item) {
        var ctx = $(this).ctx();
        var fn = new Function('e', 'with (' + ctx + ') {\n' + $(this).attr('onkeypress') + '\nconsole.log("onkeypress");\n}');
        this.onkeypress = fn;
      });
      $('[onkeyup]').each(function(index, item) {
        var ctx = $(this).ctx();
        var fn = new Function('e', 'with (' + ctx + ') {\n' + $(this).attr('onkeyup') + '\nconsole.log("onkeyup");\n}');
        this.onkeyup = fn;
      });
      $('[onchange]').each(function(index, item) {
        var ctx = $(this).ctx();
        var fn = new Function('e', 'with (' + ctx + ') {\n' + $(this).attr('onchange') + '\nconsole.log("onchange");\n}');
        this.onchange = fn;
      });
      $('[onmouseover]').each(function(index, item) {
        var ctx = $(this).ctx();
        var fn = new Function('e', 'with (' + ctx + ') {\n' + $(this).attr('onmouseover') + '\nconsole.log("onmouseover");\n}');
        this.onmouseover = fn;
      });

      scan();

    });
  </script>
  
</body>

</html>