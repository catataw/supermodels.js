<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="user-scalable=no">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="description" content="">
  <meta name="author" content="">

  <title>Superviews</title>

  <style>
    .active {
      color: red;
    }
  </style>
  <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script src="../dist/supermodels.js"></script>
</head>

<body>

  <h1>A look at loops</h1>
  
  <div ui-with="app" ui-title="name">

    <p ui-text="name"></p>

    <ul ui-for="items">
      <li ui-hide="isLast" ui-class="{ active: isCurrent, first: isFirst, last: isLast }">
        <span ui-text="name"></span>&nbsp;|&nbsp;<span ui-text="text"></span>
        <ul ui-for="subItems">
          <li>
            <span ui-text="foo"></span>
            <ul ui-for="subItems">
              <li>
                <span ui-text="bar"></span>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>

    <div ui-with="something">
      <p ui-text="whatever"></p>  
    </div>
    <div ui-with="items">
      <p ui-text="__parent.name"></p>  
    </div>
    
    <input type="number" ui-value="currentItemId" onchange="currentItemId = this.value" 
      placeholder="Set active item" min=0 ui-max="items.length - 1" style="width: 200px" />
    <pre id="json">
      
    </pre>
  </div>

  <script>
  var prefix = 'ui';
  
    function genAttrName(name) {
      return prefix + '-' + name;
    }
    
    var ui = {
      for: function(value) {
        var $this = $(this);
        var dataKey = prefix + '-for-data';
        var templateKey = prefix + '-for-template';
        
        // If the array hasn't changed 'shape', do no work
        var data = $this.data(dataKey);
        if (data) {
          if (data.length === value.length) {
            // todo: and they contain the same items etc...
            superview($this);
            return;
          }
        }
        
        var template = $this.data(templateKey);
        if (!template) {
          template = $this.html();
          $this.data(templateKey, template);
        }
        
        var $item;
        var withAttr = genAttrName('with');
        
        $this.html('');
        for (var i = 0; i < value.length; i++) {
          $this.append($(template).attr(withAttr, '[' + i + ']'));
        }
        
        // make a copy of the current items
        $this.data(dataKey, value.slice());
        
        superview($this);
      },
      value: function(value) {
        this.value = value;
      },
      text: function(value) {
        this.innerText = value;
      },
      hide: function(value) {
        this.style.display = value ? 'none' : '';
      },
      title: function(value) {
        this.title = value;
      },
      max: function(value) {
        this.max = value;
      },
      'class': function(value) {
        var keys = Object.keys(value), key, val;
        
        for (var i = 0; i < keys.length; i++) {
          key = keys[i];
          val = value[key];
          $(this)[val ? 'addClass' : 'removeClass'](key);
        }
      }
    };

    var app = supermodels({
      name: String,
      currentItemId: Number,
      something: {
        whatever: String
      },
      items: [{
        name: '',
        text: '',
        quantity: Number,
        index: {
          __enumerable: false,
          __get: function() {
            var parent = this.__parent;
            var index = parent.indexOf(this);
            return index;
          }
        },
        get isCurrent() {
          return this.index === this.__parent.__parent.currentItemId;
        },
        get isFirst() {
          return this.index === 0;
        },
        get isLast() {
          return this.index === (this.__parent.length - 1);
        },
        subItems: [{
          foo: String,
          subItems: [{
           bar: String 
          }]
        }]
      }]
    });

    var newItem1 = app.items.create();
    newItem1.name = 'item1';
    newItem1.text = 'item1 text';
    newItem1.quantity = 4;
    app.items.push(newItem1);
    
    var newItem2 = app.items.create();
    newItem2.name = 'item2';
    newItem2.text = 'item2 text';
    newItem2.quantity = 4;
    app.items.push(newItem2);
    
    // add a few blank items
    app.items.push(app.items.create());
    app.items.push(app.items.create());
    app.items.push(app.items.create());
    app.items.push(app.items.create());
    
    var subItem = newItem1.subItems.create();
    subItem.foo = 'foofoo';
    newItem1.subItems.push(subItem);
    
    var subSubItem = subItem.subItems.create();
    subSubItem.bar = 'barbar';
    subItem.subItems.push(subSubItem);
    
    function renderJson() {
      $('#json').html(JSON.stringify(app, null, 2));
    }
    renderJson()
    
    app.on('change', function() {
      renderJson();
      superview();
    });







    var keys = Object.keys(ui);

    function superview(el) {
      var $el = $(el || document.body);

      keys.forEach(function(key) {
        var attrName = genAttrName(key);
        var selector = '[' + attrName + ']';
        var $found = $(selector, $el);

        $found.each(function(index, item) {
          var $this = $(this);
          
          if ($(this).closest(document.documentElement).length === 0) {
            // selection has been removed
            return;
          }
          
          if (key === 'for') {
            // only take upper most 'for' elements.
            // i.e. '[for]' is ok, '[for] [for]' is not
            if ($this.parentsUntil($el, selector).length > 0) {
              return;
            }
          }
          
          var expr = $this.attr(attrName);
          var ctx = $this.ctx();

          var statement = '(function() {\n  with (' + ctx + ') {\n return ' + expr + '\n}})();'
          var value = eval(statement);
          
          ui[key].call(item, value);
          
        });
      });

    }

    (function($) {

      $.fn.ctx = function() {
        var $this = $(this);
        var withs = [];
        var contextAttrs = [genAttrName('with'), genAttrName('for')];
        var contextAttrsSelectors = contextAttrs.map(function(item) {
          return '[' + item + ']';
        });
        
        function push(name, dot) {
          if (dot !== false) {
            withs.push('.');
          }
          withs.push(name);
        }
        
        if ($this.is(contextAttrsSelectors[0])) {
          push($this.attr(contextAttrs[0]));
        }
        
        $this.parents(contextAttrsSelectors.join(',')).each(function() {
          var $parent = $(this);
          
          if ($parent.is(contextAttrsSelectors[0])) {
            push($parent.attr(contextAttrs[0]));
            
          } else if ($parent.is(contextAttrsSelectors[1])) {
            push($parent.attr(contextAttrs[1]), false);
            
          }
        });
        
        withs.shift();
        return withs.reverse().join('');

      };

    }(jQuery));

    $(function() {

      // Contextify dom 'on' events
      var events = ['onclick', 'ondblclick', 'onmousedown', 'onmouseup', 'onmouseover', 'onmousemove', 'onmouseout', 
        'ondragstart', 'ondrag', 'ondragenter', 'ondragleave', 'ondragover', 'ondrop', 'ondragend', 'onkeydown', 
        'onkeypress', 'onkeyup', 'onload', 'onunload', 'onabort', 'onerror', 'onresize', 'onscroll', 'select', 'onchange', 
        'onsubmit', 'onreset', 'onfocus', 'onblur'];
      
      for (var i; i < events.length - 1; i++) {
        $('[' + name + ']').each(function() {
          var ctx = $(this).ctx();
          var fn = new Function('e', 'with (' + ctx + ') {\n' + $(this).attr(name) + '\nconsole.log(superview' + name + '");\n}');
          this[name] = fn;
        });
      }
      
      superview();

    });
  </script>
  
</body>

</html>